name: Test Setup drun Action

on:
  push:
    branches: [ main, master ]
    paths:
      - 'action.yml'
      - '.github/workflows/test-action.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'action.yml'
      - '.github/workflows/test-action.yml'
  workflow_dispatch:

jobs:
  test-platforms:
    name: Test on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
      
      - name: Test setup drun (latest)
        uses: ./
        id: setup-latest
        with:
          version: 'latest'
      
      - name: Verify drun installation
        shell: bash
        run: |
          echo "Testing drun installation..."
          
          # Check if drun is in PATH
          if ! command -v drun >/dev/null 2>&1; then
            echo "âŒ drun not found in PATH"
            exit 1
          fi
          
          # Check version
          echo "âœ… drun found in PATH"
          drun --version
          
          # Verify outputs
          echo "ðŸ“Š Action outputs:"
          echo "  Version: ${{ steps.setup-latest.outputs.version }}"
          echo "  Path: ${{ steps.setup-latest.outputs.path }}"
          echo "  Cache hit: ${{ steps.setup-latest.outputs.cache-hit }}"
          
          # Test basic functionality
          echo "ðŸ§ª Testing basic functionality..."
          drun --help >/dev/null
          echo "âœ… drun --help works"
      
      - name: Test with example drun file
        shell: bash
        run: |
          # Create a simple test drun file
          cat > test.drun << 'EOF'
          # Simple test drun file
          task hello:
            shell: echo "Hello from drun on ${{ matrix.os }}!"
          
          task version:
            shell: drun --version
          EOF
          
          echo "ðŸ§ª Testing drun execution..."
          drun hello
          drun version

  test-versions:
    name: Test version ${{ matrix.version }} on Ubuntu
    strategy:
      fail-fast: false
      matrix:
        version: ['latest']  # Add specific versions here when available
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Test setup drun (${{ matrix.version }})
        uses: ./
        id: setup-version
        with:
          version: ${{ matrix.version }}
      
      - name: Verify installation
        run: |
          echo "Testing drun ${{ matrix.version }}..."
          drun --version
          echo "âœ… Version test passed"

  test-caching:
    name: Test caching functionality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: First installation (should download)
        uses: ./
        id: first-install
        with:
          version: 'latest'
          cache: 'true'
      
      - name: Verify first installation
        run: |
          echo "First install cache hit: ${{ steps.first-install.outputs.cache-hit }}"
          drun --version
      
      - name: Second installation (should use cache)
        uses: ./
        id: second-install
        with:
          version: 'latest'
          cache: 'true'
      
      - name: Verify caching worked
        run: |
          echo "Second install cache hit: ${{ steps.second-install.outputs.cache-hit }}"
          drun --version
          
          # Note: Cache hit might still be false on first run due to GitHub Actions cache behavior
          echo "âœ… Caching test completed"

  test-no-cache:
    name: Test without caching
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install without cache
        uses: ./
        id: no-cache
        with:
          version: 'latest'
          cache: 'false'
      
      - name: Verify installation
        run: |
          echo "Cache disabled - cache hit: ${{ steps.no-cache.outputs.cache-hit }}"
          drun --version
          echo "âœ… No-cache test passed"

  test-custom-token:
    name: Test with custom token
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install with custom token
        uses: ./
        id: custom-token
        with:
          version: 'latest'
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify installation
        run: |
          drun --version
          echo "âœ… Custom token test passed"

  integration-test:
    name: Integration test with real drun workflow
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup drun
        uses: ./
        with:
          version: 'latest'
      
      - name: Create comprehensive test workflow
        run: |
          cat > integration-test.drun << 'EOF'
          # Integration test drun file
          
          task setup:
            shell: |
              echo "Setting up test environment..."
              mkdir -p test-output
              echo "Setup complete" > test-output/setup.txt
          
          task test:
            depends: [setup]
            shell: |
              echo "Running tests..."
              if [ -f test-output/setup.txt ]; then
                echo "âœ… Setup dependency worked"
                echo "Test passed" > test-output/test.txt
              else
                echo "âŒ Setup dependency failed"
                exit 1
              fi
          
          task build:
            depends: [test]
            shell: |
              echo "Building application..."
              echo "Build complete" > test-output/build.txt
              echo "âœ… Build successful"
          
          task cleanup:
            shell: |
              echo "Cleaning up..."
              rm -rf test-output
              echo "âœ… Cleanup complete"
          
          task all:
            depends: [build, cleanup]
            shell: echo "âœ… All tasks completed successfully!"
          EOF
      
      - name: Run integration test
        run: |
          echo "ðŸš€ Running integration test..."
          drun all
          echo "âœ… Integration test passed!"

  summary:
    name: Test Summary
    needs: [test-platforms, test-versions, test-caching, test-no-cache, test-custom-token, integration-test]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Test Results Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.test-platforms.result }}" == "success" ]]; then
            echo "âœ… Platform tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Platform tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test-versions.result }}" == "success" ]]; then
            echo "âœ… Version tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Version tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test-caching.result }}" == "success" ]]; then
            echo "âœ… Caching tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Caching tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test-no-cache.result }}" == "success" ]]; then
            echo "âœ… No-cache tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ No-cache tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.test-custom-token.result }}" == "success" ]]; then
            echo "âœ… Custom token tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Custom token tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.integration-test.result }}" == "success" ]]; then
            echo "âœ… Integration tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Integration tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Setup drun GitHub Action testing completed!" >> $GITHUB_STEP_SUMMARY